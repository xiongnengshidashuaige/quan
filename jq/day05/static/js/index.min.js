var cur_section, trans_list;

var callbacks = {
    afterLoad: function(anchorLink, index) {
        activeAniSection(index);
        activeTranSection(index);
        setTimeout(function() {
            if (cur_section == index) {
                return
            }
            unactiveAniSection(cur_section)
        }, 1e3)
    },
    onLeave: function(index, nextIndex, direction) {
        cur_section = index;
        unactiveTranSection(index);
        changeContainer(nextIndex);
        changeGuide(nextIndex)
    }
};

function updateMenu(index) {
    $(".menu span").removeClass("selected").eq(index - 1).addClass("selected")
}

function activeAniSection(index) {
    $(".section" + index).addClass("active_ani");
    if ("section" + index in trans_list) {
        trans_list["section" + index].start()
    }
}

function activeTranSection(index) {
    $(".section" + index).addClass("active_tran")
}

function unactiveAniSection(index) {
    $(".section" + index).removeClass("active_ani");
    if ("section" + index in trans_list) {
        trans_list["section" + index].stop()
    }
}

function unactiveTranSection(index) {
    $(".section" + index).removeClass("active_tran")
}

function changeContainer(index) {
    $("body").attr("data-section_id", index)
}

function changeGuide(index) {
    if (index == 4) {
        $(".guide").attr("data-status", "end")
    } else {
        $(".guide").attr("data-status", "start")
    }
}

function init_frame() {
    $("#fullpage").fullpage({
        onLeave: callbacks.onLeave,
        afterLoad: callbacks.afterLoad
    })
}

function init_section() {
    activeAniSection(1);
    activeTranSection(1);
    $(".section").show()
}

function init_section1() {
    cur_section = 1;
    changeContainer(1);
    $(".section1 .container_video").css("z-index", "-1")
}

function init_img() {
    $("img").each(function() {
        var src = this.getAttribute("data-src");
        src && (this.src = src)
    });
    $(".section1 .planet_b").css("background-image", "url(static/img/index_complex/s1/planet_b.png)");
    $(".section1 .planet_s").css("background-image", "url(static/img/index_complex/s1/planet_s.png)");
    $(".section1 .planet_l").css("background-image", "url(static/img/index_complex/s1/planet_l.png)");
    $(".section1 .planet_r").css("background-image", "url(static/img/index_complex/s1/planet_r.png)");
    $(".section1 .planet_rr").css("background-image", "url(static/img/index_complex/s1/planet_rr.png)");
    $(".section1 .light_b").css("background-image", "url(static/img/index_complex/s1/light_b.png)");
    $(".section1 .light_s").css("background-image", "url(static/img/index_complex/s1/light_s.png)")
}

function init_star() {
    trans_list = {
        section1: (new Trans).init(".section1", 20),
        section2: (new Trans).init(".section2", 20),
        section3: (new Trans).init(".section3", 20),
        section4: (new Trans).init(".section4", 20)
    }
}

function init_board() {
    var board = $(".board_instance"), len = board.size(), cur = 0, timer;
    var interval = function() {
        $(".u_btn_board").eq((cur + 1) % len).trigger("click")
    }
    ;
    if (len < 3) {
        $(".u_btn_board").bind("click", function() {
            var id = parseInt($(this).find(".c_btn").html(), 10)
              , tar = $(".u_btn_board").eq(id - 1).find(".c_btn");
            if (tar.hasClass("active")) {
                return
            }
            window.clearInterval(timer);
            cur = id - 1;
            board.hide();
            board.eq(id - 1).fadeIn();
            $(".u_btn_board .c_btn").removeClass("active");
            tar.addClass("active");
            timer = setInterval(interval, 5e3)
        })
    } else {
        $(".board").css("width", 820 * (2 * len - 1) + "px");
        $(".u_btn_board").bind("click", function() {
            var id = parseInt($(this).find(".c_btn").html(), 10)
              , tar = $(".u_btn_board").eq(id - 1).find(".c_btn");
            if (tar.hasClass("active")) {
                return
            }
            window.clearInterval(timer);
            cur = id - 1;
            $(".board").css("left", (id - 1) * -1640 + "px");
            $(".board_instance").removeClass("active");
            $(".u_btn_board .c_btn").removeClass("active");
            tar.addClass("active");
            $(".board_instance").eq(id - 1).addClass("active");
            timer = setInterval(interval, 5e3)
        })
    }
    timer = setInterval(interval, 5e3);
    $(document).on("keydown", function(e) {
        switch (e.keyCode || e.which) {
        case 37:
            $(".u_btn_board").eq((cur - 1 + len) % len).trigger("click");
            break;
        case 39:
            $(".u_btn_board").eq((cur + 1) % len).trigger("click");
            break;
        default:
        }
    })
}

function init_guide() {
    changeGuide(1);
    $(".guide_inner").bind("click", function() {
        var $obj = $(this).parent();
        if ($obj.attr("data-status") == "start") {
            $.fn.fullpage.moveSectionDown();
            return
        }
        if ($obj.attr("data-status") == "end") {
            $.fn.fullpage.moveTo(1);
            return
        }
    })
}

$(function() {
    init_img();
    init_star();
    init_board();
    init_frame();
    init_section();
    init_section1();
    init_guide()
});
